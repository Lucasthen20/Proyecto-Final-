import tkinter as tk
from tkinter import ttk, messagebox, simpledialog
import sqlite3
import datetime
from tkcalendar import DateEntry

class InventarioApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Sistema de Inventario")

        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()
        ancho = int(screen_width * 0.9)
        alto = int(screen_height * 0.9)
        self.root.geometry(f"{ancho}x{alto}")
        self.root.configure(bg="#eaeaea")

        self.conn = sqlite3.connect("inventario.db")
        self.cursor = self.conn.cursor()
        self.cursor.execute("""
            CREATE TABLE IF NOT EXISTS productos (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nombre TEXT UNIQUE,
                cantidad INTEGER,
                precio_compra REAL,
                precio_venta REAL,
                alerta_minima INTEGER DEFAULT 0
            )
        """)
        self.cursor.execute("""
            CREATE TABLE IF NOT EXISTS ventas (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nombre TEXT,
                cantidad INTEGER,
                total REAL,
                fecha TEXT
            )
        """)
        self.conn.commit()

        frame_principal = tk.Frame(root, bg="white", bd=2, relief=tk.RIDGE)
        frame_principal.pack(fill="both", expand=True, padx=20, pady=20)

        frame_agregar = tk.LabelFrame(frame_principal, text="Agregar / Editar producto", bg="white", font=("Arial", 14, "bold"))
        frame_agregar.pack(fill="x", padx=20, pady=10)

        campos = [
            ("Nombre:", "nombre_entry", 20),
            ("Cantidad:", "cantidad_entry", 8),
            ("Compra:", "compra_entry", 8),
            ("Venta:", "precio_entry", 8),
            ("Alerta mínima:", "alerta_entry", 8),
        ]
        for i, (texto, attr, ancho) in enumerate(campos):
            tk.Label(frame_agregar, text=texto, bg="white", font=("Arial", 13)).grid(row=0, column=i * 2, padx=8, pady=8, sticky="e")
            entry = tk.Entry(frame_agregar, font=("Arial", 13), width=ancho)
            entry.grid(row=0, column=i * 2 + 1, padx=8, pady=8)
            setattr(self, attr, entry)

        botones = [
            ("Agregar", "#4CAF50", self.agregar_producto),
            ("Eliminar", "#F44336", self.eliminar_producto),
            ("Cargar", "#4CAF50", self.cargar_producto),
            ("Actualizar", "#4CAF50", self.actualizar_producto),
            ("Historial", "#4CAF50", self.ver_historial),
           
        ]

        frame_botones = tk.Frame(frame_agregar, bg="white")
        frame_botones.grid(row=1, column=0, columnspan=10, pady=10, sticky="w")

        for txt, color, cmd in botones:
            tk.Button(frame_botones, text=txt, bg=color, fg="white", font=("Arial", 13, "bold"), command=cmd, width=12).pack(side="left", padx=5, pady=5)

        frame_buscar = tk.LabelFrame(frame_principal, text="Buscar producto", bg="white", font=("Arial", 14, "bold"))
        frame_buscar.pack(fill="x", padx=20, pady=10)

        self.barra_busqueda = tk.Entry(frame_buscar, font=("Arial", 13), width=40)
        self.barra_busqueda.pack(anchor="w", padx=10, pady=5)
        self.barra_busqueda.bind("<KeyRelease>", self.buscar_producto)

        frame_lista = tk.LabelFrame(frame_principal, text="Lista de productos", bg="white", font=("Arial", 18, "bold"), height=350)
        frame_lista.pack(fill="x", padx=20, pady=10)
        frame_lista.pack_propagate(False)

        columnas = ("Nombre", "Cantidad", "Compra", "Venta")

        estilo = ttk.Style()
        estilo.configure("Treeview", font=("Arial", 10), rowheight=16)
        estilo.configure("Treeview.Heading", font=("Arial", 10, "bold"))

        self.lista_productos = ttk.Treeview(frame_lista, columns=columnas, show="headings", height=40)
        for col in columnas:
            self.lista_productos.heading(col, text=col)
            self.lista_productos.column(col, anchor="center")
            self.lista_productos.pack(fill="both", padx=10, pady=1)

        estilo = ttk.Style()
        estilo.configure("Treeview", font=("Arial", 16), rowheight=25)
        estilo.configure("Treeview.Heading", font=("Arial", 14, "bold"))
        estilo.map("Treeview", background=[("selected", "#2196F3")])

        frame_venta = tk.LabelFrame(frame_principal, text="Vender producto", bg="white", font=("Arial", 14, "bold"))
        frame_venta.pack(fill="x", padx=20, pady=10)
        tk.Label(frame_venta, text="Cantidad a vender:", bg="white", font=("Arial", 13)).pack(side="left", padx=10)
        self.cantidad_vender_entry = tk.Entry(frame_venta, font=("Arial", 13), width=10)
        self.cantidad_vender_entry.pack(side="left", padx=10)
        tk.Button(frame_venta, text="Vender", bg="#2196F3", fg="white", font=("Arial", 13, "bold"), command=self.vender_producto).pack(side="left", padx=10)

        self.actualizar_lista()

    def agregar_producto(self):
        nombre = self.nombre_entry.get().strip()
        cantidad = self.cantidad_entry.get().strip()
        compra = self.compra_entry.get().strip()
        venta = self.precio_entry.get().strip()
        alerta = self.alerta_entry.get().strip() or "0"

        if not nombre or not cantidad or not compra or not venta:
            messagebox.showwarning("Error", "Completa todos los campos.")
            return

        try:
            cantidad = int(cantidad)
            compra = float(compra)
            venta = float(venta)
            alerta = int(alerta)
        except ValueError:
            messagebox.showwarning("Error", "Datos inválidos.")
            return

        try:
            self.cursor.execute("""
                INSERT INTO productos (nombre, cantidad, precio_compra, precio_venta, alerta_minima)
                VALUES (?, ?, ?, ?, ?)
            """, (nombre, cantidad, compra, venta, alerta))
            self.conn.commit()
        except sqlite3.IntegrityError:
            messagebox.showwarning("Error", "Producto duplicado.")
            return

        self.limpiar_campos()
        self.actualizar_lista()

    def vender_producto(self):
        seleccionado = self.lista_productos.selection()
        if not seleccionado:
            return
        nombre = self.lista_productos.item(seleccionado[0])["values"][0]
        cantidad_vender = self.cantidad_vender_entry.get().strip()

        try:
            cantidad_vender = int(cantidad_vender)
        except ValueError:
            messagebox.showwarning("Error", "Cantidad inválida.")
            return

        self.cursor.execute("SELECT cantidad, precio_venta, alerta_minima FROM productos WHERE nombre=?", (nombre,))
        actual = self.cursor.fetchone()
        if actual is None or actual[0] < cantidad_vender:
            messagebox.showwarning("Error", "No hay suficiente cantidad.")
            return

        nueva_cantidad = actual[0] - cantidad_vender
        self.cursor.execute("UPDATE productos SET cantidad=? WHERE nombre=?", (nueva_cantidad, nombre))
        self.conn.commit()

        total_venta = cantidad_vender * actual[1]
        fecha = datetime.date.today().isoformat()
        self.cursor.execute("INSERT INTO ventas (nombre, cantidad, total, fecha) VALUES (?, ?, ?, ?)", (nombre, cantidad_vender, total_venta, fecha))
        self.conn.commit()

        self.verificar_alerta(nombre)
        self.cantidad_vender_entry.delete(0, tk.END)
        self.actualizar_lista()

   
    def ver_historial(self):
        ventana = tk.Toplevel(self.root)
        ventana.title("Historial de ventas por fecha")
        ventana.geometry("800x600")

        frame_top = tk.Frame(ventana)
        frame_top.pack(pady=10)

        tk.Label(frame_top, text="Selecciona una fecha:", font=("Arial", 12)).pack(side="left", padx=5)
        fecha_entry = DateEntry(frame_top, width=12, background='darkblue', foreground='white', borderwidth=2, date_pattern='yyyy-mm-dd')
        fecha_entry.pack(side="left", padx=5)

        total_label = tk.Label(ventana, text="Total vendido: $0.00", font=("Arial", 12, "bold"), fg="green")
        total_label.pack(pady=5)

        columnas = ("Producto", "Cantidad", "Total", "Fecha")
        tree = ttk.Treeview(ventana, columns=columnas, show="headings")
        for col in columnas:
            tree.heading(col, text=col)
            tree.column(col, anchor="center", width=180)
        tree.pack(fill="both", expand=True, padx=10, pady=10)

        def cargar_historial():
            for row in tree.get_children():
                tree.delete(row)
            fecha = fecha_entry.get()
            self.cursor.execute("SELECT nombre, cantidad, total, fecha FROM ventas WHERE fecha=?", (fecha,))
            datos = self.cursor.fetchall()
            total = 0
            for row in datos:
                tree.insert("", "end", values=row)
                total += row[2]
            total_label.config(text=f"Total vendido: ${total:.2f}")

        fecha_entry.bind("<<DateEntrySelected>>", lambda e: cargar_historial())
        cargar_historial()

    def eliminar_producto(self):
        seleccionado = self.lista_productos.selection()
        if not seleccionado:
            return
        nombre = self.lista_productos.item(seleccionado[0])["values"][0]
        self.cursor.execute("DELETE FROM productos WHERE nombre=?", (nombre,))
        self.conn.commit()
        self.actualizar_lista()

    def actualizar_producto(self):
        seleccionado = self.lista_productos.selection()
        if not seleccionado:
            return
        nombre_original = self.lista_productos.item(seleccionado[0])["values"][0]

        nombre = self.nombre_entry.get().strip()
        cantidad = self.cantidad_entry.get().strip()
        compra = self.compra_entry.get().strip()
        venta = self.precio_entry.get().strip()
        alerta = self.alerta_entry.get().strip() or "0"

        try:
            cantidad = int(cantidad)
            compra = float(compra)
            venta = float(venta)
            alerta = int(alerta)
        except ValueError:
            messagebox.showwarning("Error", "Datos inválidos.")
            return

        self.cursor.execute("""
            UPDATE productos
            SET nombre=?, cantidad=?, precio_compra=?, precio_venta=?, alerta_minima=?
            WHERE nombre=?
        """, (nombre, cantidad, compra, venta, alerta, nombre_original))
        self.conn.commit()
        self.verificar_alerta(nombre)
        self.limpiar_campos()
        self.actualizar_lista()

    def cargar_producto(self):
        seleccionado = self.lista_productos.selection()
        if not seleccionado:
            return
        nombre = self.lista_productos.item(seleccionado[0])["values"][0]
        self.cursor.execute("SELECT * FROM productos WHERE nombre=?", (nombre,))
        p = self.cursor.fetchone()
        if p:
            self.nombre_entry.delete(0, tk.END)
            self.nombre_entry.insert(0, p[1])
            self.cantidad_entry.delete(0, tk.END)
            self.cantidad_entry.insert(0, p[2])
            self.compra_entry.delete(0, tk.END)
            self.compra_entry.insert(0, p[3])
            self.precio_entry.delete(0, tk.END)
            self.precio_entry.insert(0, p[4])
            self.alerta_entry.delete(0, tk.END)
            self.alerta_entry.insert(0, p[5])

    def buscar_producto(self, event=None):
        texto = self.barra_busqueda.get().lower()
        self.cursor.execute("SELECT nombre, cantidad, precio_compra, precio_venta, alerta_minima FROM productos WHERE LOWER(nombre) LIKE ?", (f"%{texto}%",))
        productos = self.cursor.fetchall()
        self.mostrar_lista(productos)

    def actualizar_lista(self):
        self.cursor.execute("SELECT nombre, cantidad, precio_compra, precio_venta, alerta_minima FROM productos")
        productos = self.cursor.fetchall()
        self.mostrar_lista(productos)

    def mostrar_lista(self, productos):
        for item in self.lista_productos.get_children():
            self.lista_productos.delete(item)
        for nombre, cantidad, compra, venta, alerta in productos:
            tags = ("rojo",) if cantidad == 0 else ("amarillo",) if cantidad <= alerta else ()
            self.lista_productos.insert("", "end", values=(nombre, cantidad, f"${compra:.2f}", f"${venta:.2f}"), tags=tags)
        self.lista_productos.tag_configure("rojo", background="#ff8a80")
        self.lista_productos.tag_configure("amarillo", background="#fff59d")

    def verificar_alerta(self, nombre):
        self.cursor.execute("SELECT cantidad, alerta_minima FROM productos WHERE nombre=?", (nombre,))
        cantidad, alerta = self.cursor.fetchone()
        if cantidad <= alerta:
            messagebox.showwarning("¡Alerta!", f"El producto '{nombre}' está por debajo o igual al mínimo.")

    def limpiar_campos(self):
        for campo in [self.nombre_entry, self.cantidad_entry, self.compra_entry, self.precio_entry, self.alerta_entry]:
            campo.delete(0, tk.END)

if __name__ == "__main__":
    root = tk.Tk()
    app = InventarioApp(root)
    root.mainloop()
